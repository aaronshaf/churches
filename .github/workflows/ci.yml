name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint-type-and-structure:
    name: Lint, Type, and Structure Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build CSS
        run: bun run build:css

      - name: Enforce file line count limits
        run: CI=true node scripts/check-line-count.js

      - name: Run Biome check (lint + formatting)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT "origin/${{ github.base_ref }}...HEAD" | rg '^src/.*\.(ts|tsx|js|jsx|json|css)$' || true)
            if [ -z "${CHANGED_FILES}" ]; then
              echo "No source files changed in PR; skipping Biome check."
              exit 0
            fi
            echo "Running Biome on changed files:"
            echo "${CHANGED_FILES}"
            bunx biome check ${CHANGED_FILES}
          else
            bun run check
          fi

      - name: Type check
        run: bun run typecheck

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-type-and-structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create placeholder .dev.vars
        run: |
          cat > .dev.vars << EOF
          TURSO_DATABASE_URL=placeholder
          TURSO_AUTH_TOKEN=placeholder
          GOOGLE_MAPS_API_KEY=placeholder
          CLOUDFLARE_ACCOUNT_ID=placeholder
          CLOUDFLARE_ACCOUNT_HASH=placeholder
          CLOUDFLARE_IMAGES_API_TOKEN=placeholder
          OPENROUTER_API_KEY=placeholder
          BETTER_AUTH_SECRET=placeholder-secret-at-least-32-chars
          BETTER_AUTH_URL=http://localhost:8787
          GOOGLE_CLIENT_ID=placeholder
          GOOGLE_CLIENT_SECRET=placeholder
          EOF

      - name: Build application
        run: bun run build

      - name: Check build output
        run: |
          if [ ! -f "public/css/styles.css" ]; then
            echo "CSS build failed - styles.css not found"
            exit 1
          fi
          echo "Build completed successfully"

  tests:
    name: Tests with Coverage Gates
    runs-on: ubuntu-latest
    needs: lint-type-and-structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Ensure tests exist
        run: |
          TEST_COUNT=$(find src test tests -type f \( -name "*.test.ts" -o -name "*.test.tsx" -o -name "*.test.js" -o -name "*.test.jsx" -o -name "*.spec.ts" -o -name "*.spec.tsx" -o -name "*.spec.js" -o -name "*.spec.jsx" \) 2>/dev/null | wc -l | tr -d ' ')
          if [ "${TEST_COUNT}" = "0" ]; then
            echo "No tests found. Add at least one test before merging."
            exit 1
          fi
          echo "Discovered ${TEST_COUNT} test files."

      - name: Run tests with coverage
        run: |
          set -euo pipefail
          mkdir -p coverage
          bun test --coverage --coverage-reporter=text --coverage-reporter=lcov |& tee coverage/coverage-summary.txt

      - name: Enforce coverage thresholds
        run: |
          if [ ! -f coverage/coverage-summary.txt ]; then
            echo "Missing coverage summary output."
            exit 1
          fi

          if [ ! -f coverage/lcov.info ]; then
            echo "Missing coverage/lcov.info output."
            exit 1
          fi

          SUMMARY_LINE=$(rg '^All files' coverage/coverage-summary.txt | tail -n 1 || true)
          if [ -z "${SUMMARY_LINE}" ]; then
            echo "Could not find 'All files' coverage summary line."
            exit 1
          fi

          FUNCS_PCT=$(echo "${SUMMARY_LINE}" | awk -F'|' '{gsub(/ /,"",$2); print $2}')
          LINES_PCT=$(echo "${SUMMARY_LINE}" | awk -F'|' '{gsub(/ /,"",$3); print $3}')

          if ! awk -v n="${FUNCS_PCT}" 'BEGIN { exit !(n+0 >= 80) }'; then
            echo "Function coverage below 80% (${FUNCS_PCT}%)."
            exit 1
          fi

          if ! awk -v n="${LINES_PCT}" 'BEGIN { exit !(n+0 >= 80) }'; then
            echo "Line coverage below 80% (${LINES_PCT}%)."
            exit 1
          fi

          awk '
            BEGIN {
              min_branches=75;
              brf=0; brh=0;
            }
            /^BRF:/ { brf += substr($0,5) + 0; }
            /^BRH:/ { brh += substr($0,5) + 0; }
            END {
              branches_pct = (brf == 0) ? 100 : (brh * 100.0 / brf);
              printf("Branch coverage: %.2f%%\n", branches_pct);

              failed = 0;
              if (branches_pct < min_branches) { printf("Branch coverage below %d%%.\n", min_branches); failed = 1; }

              exit failed;
            }
          ' coverage/lcov.info

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    needs: lint-type-and-structure
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for hardcoded secrets
        run: |
          MATCHES=$(rg -n -i --glob '*.{ts,tsx,js,jsx}' '(api[_-]?key|api[_-]?secret|access[_-]?token|auth[_-]?token|private[_-]?key)' src \
            | rg -v '(process\.env|import\.meta\.env|c\.env|env\.|^\s*//|/\*|\* )' || true)
          if [ -n "${MATCHES}" ]; then
            echo "Potential hardcoded secrets found:"
            echo "${MATCHES}"
            exit 1
          else
            echo "No hardcoded secrets detected."
          fi

      - name: Scan dependencies for vulnerabilities
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          hide-progress: true
          ignore-unfixed: false
          severity: HIGH,CRITICAL
          exit-code: "1"
